# ============================================================
# Pi Self-Hosted Runner Registration
# Run this ONCE to register Pi as GitHub Actions runner
# After: all workflows on [self-hosted, pi] = $0 cost
# ============================================================
name: "ğŸ“ Pi Runner Registration Guide"

on:
  workflow_dispatch:
    inputs:
      pi_host:
        description: 'Pi IP address'
        required: true
        default: '192.168.4.38'
      runner_name:
        description: 'Runner name'
        required: true
        default: 'octavia-pi'

jobs:
  generate-registration:
    runs-on: [self-hosted, pi, blackroad]
    steps:
      - name: Generate Pi runner setup script
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get runner token
          TOKEN=$(curl -s -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runners/registration-token" \
            | jq -r '.token')
          
          echo "ğŸ“ Run this on Pi ${{ inputs.pi_host }}:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          cat << PIEOF
          mkdir -p ~/actions-runner && cd ~/actions-runner
          curl -o actions-runner-linux-arm64-2.321.0.tar.gz -L \
            https://github.com/actions/runner/releases/download/v2.321.0/actions-runner-linux-arm64-2.321.0.tar.gz
          tar xzf ./actions-runner-linux-arm64-2.321.0.tar.gz
          ./config.sh \
            --url https://github.com/${{ github.repository }} \
            --token ${TOKEN} \
            --name ${{ inputs.runner_name }} \
            --labels "self-hosted,pi,blackroad,arm64" \
            --unattended
          sudo ./svc.sh install && sudo ./svc.sh start
          PIEOF
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… After registration: GitHub Actions = \$0 cost"
