name: ðŸƒ Pi Runner Setup
# Deploy GitHub Actions self-hosted runners to Pi cluster
# Run this workflow ONCE per Pi to register it as a runner
# After this, all workflows using runs-on: [self-hosted, pi] = $0 cost

on:
  workflow_dispatch:
    inputs:
      pi_host:
        description: 'Pi hostname/IP to set up runner on'
        required: true
        type: choice
        options:
          - octavia
          - alice
          - aria
          - lucidia
          - cecilia
          - gematria
      runner_name:
        description: 'Runner name (defaults to pi_host)'
        required: false
      runner_group:
        description: 'Runner group'
        required: false
        default: 'blackroad-pi-cluster'

jobs:
  setup-runner:
    name: ðŸ”§ Setup Runner on ${{ github.event.inputs.pi_host }}
    runs-on: [self-hosted, pi, blackroad]   # Bootstrap only - runs on GitHub hosted
    steps:
      - uses: actions/checkout@v4

      - name: Get runner registration token
        id: get-token
        run: |
          TOKEN=$(curl -s -X POST \
            -H "Authorization: token ${{ secrets.GH_PAT }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/orgs/BlackRoad-OS/actions/runners/registration-token" | \
            python3 -c "import sys,json; print(json.load(sys.stdin)['token'])")
          echo "::add-mask::${TOKEN}"
          echo "reg_token=${TOKEN}" >> $GITHUB_OUTPUT

      - name: Deploy runner to Pi
        env:
          PI_HOST: ${{ github.event.inputs.pi_host }}
          RUNNER_NAME: ${{ github.event.inputs.runner_name || github.event.inputs.pi_host }}
          REG_TOKEN: ${{ steps.get-token.outputs.reg_token }}
        run: |
          ssh -o StrictHostKeyChecking=no blackroad@${PI_HOST} << REMOTE
            set -e
            echo "ðŸš€ Setting up GitHub Actions runner on \$(hostname)"
            
            # Install runner
            mkdir -p ~/actions-runner && cd ~/actions-runner
            
            # Detect architecture
            ARCH=\$(uname -m)
            if [ "\$ARCH" = "aarch64" ]; then
              RUNNER_ARCH="arm64"
            elif [ "\$ARCH" = "armv7l" ]; then
              RUNNER_ARCH="arm"
            else
              RUNNER_ARCH="x64"
            fi
            
            RUNNER_VERSION="2.323.0"
            RUNNER_FILE="actions-runner-linux-\${RUNNER_ARCH}-\${RUNNER_VERSION}.tar.gz"
            
            if [ ! -f "run.sh" ]; then
              curl -o \$RUNNER_FILE -L \
                "https://github.com/actions/runner/releases/download/v\${RUNNER_VERSION}/\${RUNNER_FILE}"
              tar xzf \$RUNNER_FILE
              rm \$RUNNER_FILE
            fi
            
            # Configure (non-interactive)
            ./config.sh \
              --url https://github.com/BlackRoad-OS \
              --token ${REG_TOKEN} \
              --name ${RUNNER_NAME} \
              --labels "self-hosted,pi,\$RUNNER_ARCH,${PI_HOST},blackroad-pi-cluster" \
              --work "_work" \
              --unattended \
              --replace || true
            
            # Install and start service
            sudo ./svc.sh install || true
            sudo ./svc.sh start || true
            
            echo "âœ… Runner ${RUNNER_NAME} active on \$(hostname)"
          REMOTE
