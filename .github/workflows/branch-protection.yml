name: "üõ°Ô∏è Branch Protection Enforcer"

on:
  schedule:
    - cron: '0 4 * * 0'  # Weekly Sunday 4 AM
  workflow_dispatch:
    inputs:
      org:
        description: 'Org to protect (or "all")'
        default: 'all'

jobs:
  protect-branches:
    runs-on: [self-hosted, pi, blackroad]
    steps:
      - uses: actions/checkout@v4
      - name: Apply branch protection to all orgs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ADMIN_TOKEN: ${{ secrets.ADMIN_TOKEN }}
        run: |
          TOKEN="${ADMIN_TOKEN:-$GH_TOKEN}"
          
          ORGS=(
            "BlackRoad-OS-Inc"
            "BlackRoad-OS"
            "blackboxprogramming"
            "BlackRoad-AI"
            "BlackRoad-Cloud"
            "BlackRoad-Security"
          )
          
          for org in "${ORGS[@]}"; do
            echo "üîí Protecting $org default branches..."
            # Get repos
            repos=$(gh api "orgs/$org/repos" --paginate \
              --jq '[.[] | select(.archived == false) | .name]' 2>/dev/null \
              | python3 -c "import json,sys; [print(r) for r in json.load(sys.stdin)]" 2>/dev/null | head -5)
            
            for repo in $repos; do
              # Set basic branch protection on default branch
              DEFAULT=$(gh api "repos/$org/$repo" --jq '.default_branch' 2>/dev/null)
              if [ -n "$DEFAULT" ]; then
                gh api "repos/$org/$repo/branches/$DEFAULT/protection" \
                  --method PUT \
                  --field required_status_checks=null \
                  --field enforce_admins=false \
                  --field required_pull_request_reviews=null \
                  --field restrictions=null 2>/dev/null && \
                  echo "  ‚úÖ $org/$repo:$DEFAULT" || \
                  echo "  ‚ö†Ô∏è  $org/$repo (skipped)"
              fi
            done
          done
          echo "Branch protection sweep complete"
