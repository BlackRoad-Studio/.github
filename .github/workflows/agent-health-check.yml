name: Agent Health Check
on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:
jobs:
  health-check:
    runs-on: [self-hosted, pi]
    steps:
      - uses: actions/checkout@v4
      - name: Check Pi tunnel
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://api.blackroad.io/health 2>/dev/null || echo "000")
          echo "API health: $STATUS"
          if [ "$STATUS" != "200" ]; then
            echo "::warning::API health check returned $STATUS"
          fi
      - name: Check Cloudflare Worker
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://blackroad.io 2>/dev/null || echo "000")
          echo "Main site: $STATUS"
      - name: Memory journal entry
        run: |
          echo "{\"ts\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"action\":\"health-check\",\"entity\":\"github-actions\",\"detail\":\"Scheduled health check completed\"}" >> memory/journals/master-journal.jsonl || true
