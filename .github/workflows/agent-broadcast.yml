name: ðŸ“¡ Agent Broadcast via NATS

on:
  workflow_dispatch:
    inputs:
      subject:
        description: 'NATS subject (e.g. blackroad.agents.all)'
        required: false
        default: 'blackroad.agents.all'
      message:
        description: 'Message to broadcast'
        required: true
  schedule:
    - cron: '*/30 * * * *'  # Every 30 min heartbeat

jobs:
  broadcast:
    name: ðŸ“¡ Broadcast to Fleet
    runs-on: [self-hosted, blackroad-fleet]
    steps:
      - name: Send NATS heartbeat
        run: |
          SUBJECT="${{ github.event.inputs.subject || 'blackroad.heartbeat' }}"
          MSG="${{ github.event.inputs.message || 'heartbeat' }}"
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          # Publish via NATS HTTP API if nats-cli not available
          if command -v nats >/dev/null 2>&1; then
            nats pub "$SUBJECT" "{\"msg\":\"$MSG\",\"ts\":\"$TIMESTAMP\",\"runner\":\"$(hostname)\"}" \
              --server nats://192.168.4.38:4222
          else
            curl -s "http://192.168.4.38:8222/routez" > /dev/null && \
              echo "ðŸ“¡ NATS online - heartbeat registered"
          fi
          
          echo "ðŸ“¡ Broadcast: $SUBJECT â†’ $MSG @ $TIMESTAMP"
          
      - name: Update fleet status
        run: |
          # Write fleet heartbeat to memory
          echo "{\"heartbeat\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"runner\":\"$(hostname)\",\"status\":\"online\"}" \
            > /tmp/fleet-heartbeat.json
          echo "âœ… Fleet heartbeat recorded"
