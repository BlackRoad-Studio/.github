name: ðŸ¥ Pi Cluster Health + Failover
on:
  schedule:
    - cron: '*/15 * * * *'   # Every 15 minutes
  workflow_dispatch:

jobs:
  health-check:
    name: Check Pi Cluster
    runs-on: [self-hosted, pi]
    outputs:
      pis_online: ${{ steps.check.outputs.pis_online }}
      failover_needed: ${{ steps.check.outputs.failover_needed }}

    steps:
      - uses: actions/checkout@v4

      - name: Check all Pi agents
        id: check
        run: |
          ONLINE=()
          OFFLINE=()
          declare -A PIS=(
            [gematria]="159.65.43.12"
            [octavia]="100.66.235.47"
            [alice]="100.77.210.18"
            [aria]="100.109.14.17"
            [lucidia]="100.83.149.86"
            [cecilia]="100.72.180.98"
          )
          for name in "${!PIS[@]}"; do
            ip="${PIS[$name]}"
            if ping -c1 -W2 "$ip" >/dev/null 2>&1; then
              ONLINE+=("$name")
              echo "âœ… $name ($ip) ONLINE"
            else
              OFFLINE+=("$name")
              echo "âŒ $name ($ip) OFFLINE"
            fi
          done
          echo "pis_online=${ONLINE[*]}" >> $GITHUB_OUTPUT
          [ ${#OFFLINE[@]} -gt 3 ] && echo "failover_needed=true" >> $GITHUB_OUTPUT || echo "failover_needed=false" >> $GITHUB_OUTPUT

      - name: Update platform registry
        run: |
          python3 - << 'PY'
          import json, os, subprocess
          registry_path = "agents/platform-registry/registry.json"
          if os.path.exists(registry_path):
              with open(registry_path) as f:
                  reg = json.load(f)
              reg['last_health_check'] = subprocess.check_output(['date','-u','+%Y-%m-%dT%H:%M:%SZ']).decode().strip()
              with open(registry_path, 'w') as f:
                  json.dump(reg, f, indent=2)
              print("âœ… Registry updated")
          PY

  trigger-failover:
    name: Activate Failover Chain
    runs-on: [self-hosted, pi]
    needs: health-check
    if: needs.health-check.outputs.failover_needed == 'true'
    steps:
      - uses: actions/checkout@v4
      - name: Activate gematria as primary
        run: |
          echo "âš ï¸ Pi cluster degraded â€” gematria taking primary"
          # Update Cloudflare DNS to point to gematria directly
          curl -s -X PATCH \
            "https://api.cloudflare.com/client/v4/zones/${{ secrets.CF_ZONE_ID }}/dns_records/$(
              curl -s "https://api.cloudflare.com/client/v4/zones/${{ secrets.CF_ZONE_ID }}/dns_records?name=api.blackroad.io" \
                -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" | python3 -c 'import sys,json; print(json.load(sys.stdin)["result"][0]["id"])'
            )" \
            -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"content": "159.65.43.12", "type": "A", "proxied": true}' | \
            python3 -c 'import sys,json; d=json.load(sys.stdin); print("Failover:", "ok" if d["success"] else "failed")'
