name: Railway Continuous Deploy
on:
  push:
    branches: [master, main]
    paths:
      - 'blackroad-core/**'
      - 'blackroad-api/**'
      - 'blackroad-gateway/**'
      - 'api/**'
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy (or "all")'
        default: all

jobs:
  railway-deploy:
    name: Deploy to Railway
    runs-on: [self-hosted, pi, octavia]
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: |
          if ! command -v railway &>/dev/null; then
            npm install -g @railway/cli --prefix ~/npm-global 2>&1 | tail -2
          fi
          RAILWAY_BIN="$HOME/npm-global/bin/railway"
          [ -f "$RAILWAY_BIN" ] && echo "$HOME/npm-global/bin" >> $GITHUB_PATH
          railway --version 2>/dev/null || echo "railway not in PATH"

      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "⚠️  RAILWAY_TOKEN not set — set in repo Settings → Secrets"
            exit 0
          fi
          SERVICE="${{ github.event.inputs.service || 'all' }}"
          echo "�� Deploying service: $SERVICE"
          
          if [ "$SERVICE" = "all" ]; then
            railway up --detach 2>&1 | tail -5 || true
          else
            railway up --service "$SERVICE" --detach 2>&1 | tail -5 || true
          fi

      - name: Health Check
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          [ -z "$RAILWAY_TOKEN" ] && exit 0
          echo "Checking deployment status..."
          railway status 2>&1 | tail -10 || true

      - name: Notify Fleet
        if: always()
        run: |
          curl -s -X POST http://192.168.4.38:4010/events \
            -H "Content-Type: application/json" \
            -d "{\"event\":\"railway.deploy\",\"status\":\"${{ job.status }}\",\"service\":\"${{ github.event.inputs.service || 'auto' }}\",\"agent\":\"OCTAVIA\"}" \
            --connect-timeout 3 || true
