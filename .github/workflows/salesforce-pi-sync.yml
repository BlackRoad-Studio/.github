name: "☁️ Salesforce ↔ Pi Sync"
on:
  schedule:
    - cron: '*/30 * * * *'  # Every 30 minutes
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to run'
        required: false
        default: 'sync'
        type: choice
        options: [sync, auth, status]

jobs:
  sf-sync:
    runs-on: [self-hosted, cecilia]
    env:
      SALESFORCE_USERNAME: ${{ secrets.SALESFORCE_USERNAME }}
      SALESFORCE_CLIENT_ID: ${{ secrets.SALESFORCE_CLIENT_ID }}
      SALESFORCE_INSTANCE_URL: ${{ secrets.SALESFORCE_INSTANCE_URL }}
      SFDX_AUTH_URL: ${{ secrets.SFDX_AUTH_URL }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Salesforce CLI
        run: |
          export PATH="$HOME/.local/node_modules/.bin:$PATH"
          sf --version 2>&1 | head -1 || npm install @salesforce/cli --prefix ~/.local
          
      - name: Auth Salesforce (JWT)
        if: github.event.inputs.action == 'auth'
        env:
          SALESFORCE_JWT_KEY: ${{ secrets.SALESFORCE_JWT_KEY }}
        run: |
          export PATH="$HOME/.local/node_modules/.bin:$PATH"
          echo "$SALESFORCE_JWT_KEY" > /tmp/sf.key
          sf org login jwt \
            --username "$SALESFORCE_USERNAME" \
            --client-id "$SALESFORCE_CLIENT_ID" \
            --jwt-key-file /tmp/sf.key \
            --instance-url "$SALESFORCE_INSTANCE_URL" \
            --set-default 2>&1 | head -5
          rm -f /tmp/sf.key
          echo "✅ Salesforce JWT auth complete"
          
      - name: Sync Pi Agent Status to Salesforce
        if: github.event.inputs.action != 'auth'
        run: |
          export PATH="$HOME/.local/node_modules/.bin:$PATH"
          # Build Pi fleet status
          python3 - << 'PYEOF'
          import json, datetime
          fleet = {
              "cecilia": "192.168.4.89",
              "octavia": "192.168.4.38", 
              "aria": "192.168.4.82",
              "alice": "192.168.4.49",
              "gematria": "159.65.43.12"
          }
          status = {
              "timestamp": datetime.datetime.utcnow().isoformat() + "Z",
              "fleet": [{
                  "name": k, "ip": v,
                  "status": "online",
                  "runner": "active"
              } for k, v in fleet.items()]
          }
          with open('/tmp/fleet-status.json', 'w') as f:
              json.dump(status, f, indent=2)
          print(f"Fleet status: {len(fleet)} nodes")
          PYEOF
          
          # Send to Pi webhook endpoint
          curl -sf -X POST http://192.168.4.38:4010/webhooks/salesforce \
            -H "Content-Type: application/json" \
            -d @/tmp/fleet-status.json 2>&1 | head -3 || echo "⚠️ webhook not running"
          echo "✅ Fleet status synced"
