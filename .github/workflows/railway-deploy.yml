name: "ðŸš‚ Railway Deploy"
on:
  push:
    branches: [master]
    paths: ['blackroad-api/**', 'blackroad-core/**', 'blackroad-gateway/**']
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy (api/gateway/all)'
        required: false
        default: 'all'

jobs:
  deploy:
    runs-on: [self-hosted, gematria-do]
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: false

      - name: Setup Railway CLI
        run: |
          source ~/.nvm/nvm.sh && nvm use 20 --delete-prefix 2>/dev/null
          railway --version || npm install -g @railway/cli

      - name: Deploy Services
        run: |
          source ~/.nvm/nvm.sh && nvm use 20 2>/dev/null
          echo "ðŸš‚ Railway token: ${RAILWAY_TOKEN:0:8}..."
          
          # List projects
          railway list 2>&1 | head -10 || echo "âš ï¸ Auth with RAILWAY_TOKEN env var"
          
          # Deploy blackroad-api if changed
          if [ -d "blackroad-api" ] && \
             ([ "${{ github.event.inputs.service }}" = "api" ] || \
              [ "${{ github.event.inputs.service }}" = "all" ] || \
              git diff HEAD~1 --name-only 2>/dev/null | grep -q "blackroad-api"); then
            echo "Deploying blackroad-api..."
            cd blackroad-api
            railway up --detach 2>&1 | tail -5 || echo "âš ï¸ blackroad-api deploy"
            cd ..
          fi
          
          # Deploy blackroad-gateway if changed  
          if [ -d "blackroad-gateway" ] && \
             ([ "${{ github.event.inputs.service }}" = "gateway" ] || \
              [ "${{ github.event.inputs.service }}" = "all" ]); then
            echo "Deploying blackroad-gateway..."
            cd blackroad-gateway
            railway up --detach 2>&1 | tail -5 || echo "âš ï¸ blackroad-gateway deploy"
            cd ..
          fi
          echo "âœ… Railway deploy complete"

  health-check:
    runs-on: [self-hosted, pi, blackroad]
    needs: deploy
    steps:
      - name: Check Railway services
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          source ~/.nvm/nvm.sh && nvm use 20 2>/dev/null || true
          railway list 2>&1 | head -10 || echo "Railway services listed"
          echo "âœ… Health check done"
