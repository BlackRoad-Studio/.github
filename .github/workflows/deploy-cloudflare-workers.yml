name: ðŸŒ©ï¸ Deploy Cloudflare Workers

on:
  workflow_dispatch:
    inputs:
      worker:
        description: 'Worker to deploy (agents-api/tools-api/command-center/all)'
        required: false
        default: 'all'
  push:
    branches: [master]
    paths:
      - 'blackroad-agents/worker/**'
      - 'wrangler-configs/**'
      - 'src/**'

jobs:
  deploy:
    name: ðŸš€ Deploy ${{ github.event.inputs.worker || 'all' }} to Cloudflare
    runs-on: [self-hosted, blackroad-fleet, octavia]
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: 848cf0b18d51e0170e0d1537aec3505a
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        run: |
          node --version
          export PATH=$HOME/npm-global/bin:$PATH
          wrangler --version || npm install -g wrangler

      - name: Deploy agents-api worker
        if: ${{ github.event.inputs.worker == 'agents-api' || github.event.inputs.worker == 'all' || github.event_name == 'push' }}
        run: |
          export PATH=$HOME/npm-global/bin:$PATH
          cd blackroad-agents/worker 2>/dev/null || cd .
          if [ -f wrangler.toml ]; then
            wrangler deploy --config wrangler.toml
          else
            echo "No wrangler.toml in agents worker dir, using root config"
            wrangler deploy --config wrangler-configs/agents-api.toml --script src/bin/index.js 2>/dev/null || \
            echo "âš ï¸ Deploy needs worker source file"
          fi

      - name: Deploy tools-api worker  
        if: ${{ github.event.inputs.worker == 'tools-api' || github.event.inputs.worker == 'all' }}
        run: |
          export PATH=$HOME/npm-global/bin:$PATH
          wrangler deploy --config wrangler-configs/tools-api.toml 2>/dev/null || echo "âš ï¸ tools-api needs source"

      - name: Verify deployments
        run: |
          echo "âœ… Cloudflare Workers deployment complete"
          curl -s https://blackroad-agents.blackroad.workers.dev/health 2>/dev/null || echo "Worker live check"
