name: Domain Health Check
on:
  schedule:
    - cron: '*/30 * * * *'   # every 30 minutes
  workflow_dispatch:

jobs:
  check-domains:
    runs-on: [self-hosted, pi]
    steps:
      - uses: actions/checkout@v4

      - name: Check all domains
        id: health
        run: |
          DOMAINS=(
            "blackroad.io"
            "blackroad.network"
            "blackroad.systems"
            "blackroad.me"
            "lucidia.earth"
            "aliceqi.com"
            "lucidiaqi.com"
            "lucidia.studio"
            "blackroadai.com"
            "blackroadqi.com"
            "blackboxprogramming.io"
            "blackroad.company"
            "blackroadinc.us"
            "roadchain.io"
            "roadcoin.io"
          )
          FAILED=()
          PASSED=()
          for domain in "${DOMAINS[@]}"; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 5 --max-time 10 "https://$domain" 2>/dev/null || echo "000")
            if [ "$STATUS" = "000" ] || [ "$STATUS" = "502" ] || [ "$STATUS" = "503" ]; then
              echo "âŒ $domain â†’ HTTP $STATUS"
              FAILED+=("$domain")
            else
              echo "âœ… $domain â†’ HTTP $STATUS"
              PASSED+=("$domain")
            fi
          done
          echo "---"
          echo "âœ… ${#PASSED[@]}/15 domains healthy"
          if [ ${#FAILED[@]} -gt 0 ]; then
            echo "âš ï¸ Failed: ${FAILED[*]}"
            echo "failed_count=${#FAILED[@]}" >> $GITHUB_OUTPUT
            echo "failed_domains=${FAILED[*]}" >> $GITHUB_OUTPUT
          fi

      - name: Create issue if domains down
        if: steps.health.outputs.failed_count > 3
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const failed = '${{ steps.health.outputs.failed_domains }}';
            const count = '${{ steps.health.outputs.failed_count }}';
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Domain Health Alert: ${count} domains down`,
              body: `## Domain Health Check Failed\n\n**Down domains:**\n${failed.split(' ').map(d => `- ${d}`).join('\n')}\n\n**Time:** ${new Date().toISOString()}\n\n**Action:** Check Pi fleet and Cloudflare tunnel status.`,
              labels: ['incident', 'domain', 'auto-created']
            });
