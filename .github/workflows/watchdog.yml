name: "ðŸ‘ï¸ Watchdog"
on:
  schedule:
    - cron: '*/30 * * * *'   # Every 30 minutes
  workflow_dispatch:

jobs:
  check-and-restart:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
    steps:
      - name: Check & restart Pi agent tasks
        run: |
          REPO="${{ github.repository }}"
          
          # Check if pi-agent-tasks is running
          RUNNING=$(gh run list --workflow=pi-agent-tasks.yml --repo "$REPO" \
            --json status --jq '[.[] | select(.status == "in_progress")] | length' 2>/dev/null || echo "0")
          
          echo "Pi agent tasks in progress: $RUNNING"
          
          if [ "$RUNNING" -eq "0" ]; then
            echo "âš ï¸ No active pi-agent-tasks â€” re-triggering..."
            sleep 3
            gh workflow run pi-agent-tasks.yml --repo "$REPO" -f task=health-check 2>/dev/null
            echo "âœ… pi-agent-tasks triggered"
          fi
          
          # Report fleet status
          echo "=== Fleet Status ==="
          gh api /repos/$REPO/actions/runners --jq '.runners[] | "\(.name): \(.status)"' 2>/dev/null | head -6

      - name: Self-re-trigger after 3s gap
        if: always()
        run: |
          # This run completes (billable: ~20s on GitHub-hosted)
          # Watchdog runs every 30min via schedule - no infinite loop needed
          echo "Watchdog cycle complete at $(date -u)"
