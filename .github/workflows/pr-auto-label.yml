name: PR Auto Label
on:
  pull_request:
    types: [opened, synchronize]

jobs:
  label:
    runs-on: [self-hosted, pi]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Auto-label by changed files
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              per_page: 100
            });
            const changed = files.data.map(f => f.filename);
            const labels = new Set();

            const rules = [
              { pattern: /^\.github\/workflows\//, label: 'workflows' },
              { pattern: /^agents\//, label: 'agents' },
              { pattern: /^blackroad-sf\//, label: 'salesforce' },
              { pattern: /^wrangler-configs\//, label: 'cloudflare' },
              { pattern: /^scripts\//, label: 'scripts' },
              { pattern: /^docs\/|\.md$/, label: 'documentation' },
              { pattern: /package\.json|package-lock\.json/, label: 'dependencies' },
              { pattern: /^\.github\//, label: 'github-config' },
              { pattern: /^blackroad-web\//, label: 'web' },
              { pattern: /^memory\//, label: 'memory' },
              { pattern: /security|vault|cipher/i, label: 'security' },
            ];

            for (const file of changed) {
              for (const rule of rules) {
                if (rule.pattern.test(file)) labels.add(rule.label);
              }
            }

            if (labels.size > 0) {
              // Ensure labels exist, then apply
              for (const label of labels) {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label, color: '0075ca'
                }).catch(() => {});
              }
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: [...labels]
              });
              console.log('Applied labels:', [...labels].join(', '));
            }
