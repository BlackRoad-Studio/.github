name: ðŸŒ Configure Pi Nginx Domains

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/nginx/**'
      - '.github/workflows/configure-pi-nginx.yml'

jobs:
  configure-nginx:
    name: Apply nginx config on octavia
    runs-on: [self-hosted, blackroad-fleet, pi, octavia]
    steps:
      - uses: actions/checkout@v4

      - name: Apply nginx config
        run: |
          # Check current user and sudo access
          echo "Running as: $(id)"
          
          NGINX_CONF=/tmp/nginx-blackroad-multi.conf
          
          # Write the nginx config
          sudo tee /etc/nginx/sites-available/blackroad-multi > /dev/null << 'NGINX'
          # BlackRoad Multi-Domain Configuration
          map $host $site_root {
              default                           /var/www/blackroad;
              "~^(?<sub>[^.]+)\.blackroad\.io$" /var/www/blackroad/blackroad-$sub;
              "~^(?<sub>[^.]+)\.blackroad\.ai$" /var/www/blackroad/blackroad-$sub;
              "~^(?<sub>[^.]+)\.blackroad\.systems$" /var/www/blackroad/blackroad-$sub;
              "~^(?<sub>[^.]+)\.blackroad\.network$" /var/www/blackroad/blackroad-$sub;
              "blackroad.io"                    /var/www/blackroad;
              "blackroad.ai"                    /var/www/blackroad;
              "lucidia.earth"                   /var/www/blackroad/lucidia-earth;
              "lucidia.studio"                  /var/www/blackroad/lucidia-studio;
          }
          
          map $host $proxy_pass {
              default                      "";
              "api.blackroad.io"           "http://127.0.0.1:8787";
              "api.blackroad.ai"           "http://127.0.0.1:8787";
              "agents.blackroad.io"        "http://127.0.0.1:4010";
              "dashboard.blackroad.io"     "http://127.0.0.1:3000";
              "metrics.blackroad.io"       "http://127.0.0.1:9090";
              "grafana.blackroad.io"       "http://127.0.0.1:3109";
              "nats.blackroad.io"          "http://127.0.0.1:8222";
              "ollama.blackroad.io"        "http://127.0.0.1:11434";
          }
          
          server {
              listen 80 default_server;
              listen [::]:80 default_server;
              server_name _;
              
              location / {
                  root $site_root;
                  index index.html;
                  try_files $uri $uri/ /index.html =404;
              }
              
              location /health {
                  return 200 '{"status":"ok","fleet":"blackroad","host":"octavia-pi5"}';
                  add_header Content-Type application/json;
              }
          }
          NGINX
          
          sudo nginx -t && sudo nginx -s reload
          echo "âœ… Nginx reloaded"
          
          # Enable site if not already
          sudo ln -sf /etc/nginx/sites-available/blackroad-multi /etc/nginx/sites-enabled/ 2>/dev/null || true
          sudo nginx -s reload
          echo "âœ… All domains active"
          
      - name: Verify domains
        run: |
          curl -s http://localhost/health | python3 -m json.tool || echo "health check response received"
          echo "Nginx running: $(systemctl is-active nginx)"
