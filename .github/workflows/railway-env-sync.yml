name: Railway Env Sync
on:
  push:
    branches: [master, main]
    paths:
      - '.env.example'
      - 'scripts/setup-railway-integration.sh'
  schedule:
    - cron: '0 4 * * 0'   # weekly Sunday 4am UTC
  workflow_dispatch:
    inputs:
      environment:
        description: Target environment
        default: production
        type: choice
        options: [production, staging]

jobs:
  sync-env:
    runs-on: [self-hosted, pi]
    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: |
          which railway || npm install -g @railway/cli 2>/dev/null || \
            (curl -fsSL https://railway.app/install.sh | sh 2>/dev/null || true)

      - name: Sync environment variables
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "⚠️ RAILWAY_TOKEN not set — skipping"
            exit 0
          fi

          # Sync shared vars to all Railway projects
          PROJECTS=(
            "9d3d2549-3778-4c86-8afd-cefceaaa74d2"   # RoadWork Production
            "aa968fb7-ec35-4a8b-92dc-1eba70fa8478"   # BlackRoad Core Services
            "e8b256aa-8708-4eb2-ba24-99eba4fe7c2e"   # BlackRoad Operator
          )

          for project in "${PROJECTS[@]}"; do
            echo "Syncing vars to project $project..."
            railway variables set \
              BLACKROAD_ENV="${{ github.event.inputs.environment || 'production' }}" \
              BLACKROAD_VERSION="${{ github.sha }}" \
              BLACKROAD_REPO="${{ github.repository }}" \
              --project "$project" 2>/dev/null && \
              echo "  ✅ $project synced" || \
              echo "  ⚠️ $project failed (token may lack access)"
          done

  validate-deployments:
    runs-on: [self-hosted, pi]
    needs: sync-env
    steps:
      - name: Health check Railway services
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          SERVICES=(
            "https://blackroad-core.up.railway.app/health"
            "https://blackroad-operator.up.railway.app/health"
          )
          for svc in "${SERVICES[@]}"; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$svc" 2>/dev/null || echo "000")
            echo "$([ "$STATUS" = "200" ] && echo ✅ || echo ⚠️) $svc → $STATUS"
          done
