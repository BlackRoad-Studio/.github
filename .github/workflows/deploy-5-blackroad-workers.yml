name: Deploy 5 BlackRoad Subdomain Workers

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted, pi]
    env:
      CF_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      ACCOUNT_ID: "848cf0b18d51e0170e0d1537aec3505a"
      ZONE_ID: "d6566eba4500b460ffec6650d3b4baf6"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Write worker JS files
        run: |
          mkdir -p /tmp/workers
          cp workers/blackroad-subdomains/gateway-blackroadio.js /tmp/workers/ 2>/dev/null || \
            cp /dev/stdin /tmp/workers/gateway-blackroadio.js << 'JSEOF'
          # Fallback: files are checked in at workers/blackroad-subdomains/
          JSEOF
          ls /tmp/workers/ || true

      - name: Deploy gateway-blackroadio
        run: |
          RESP=$(curl -s --max-time 30 -X PUT \
            "https://api.cloudflare.com/client/v4/accounts/${ACCOUNT_ID}/workers/scripts/gateway-blackroadio" \
            -H "Authorization: Bearer ${CF_TOKEN}" \
            -H "Content-Type: application/javascript" \
            --data-binary @workers/blackroad-subdomains/gateway-blackroadio.js)
          echo "$RESP" | python3 -c "import json,sys; d=json.load(sys.stdin); print('Deploy gateway: SUCCESS' if d.get('success') else 'Deploy gateway: FAILED - '+str(d.get('errors')))"

      - name: Deploy cli-blackroadio
        run: |
          RESP=$(curl -s --max-time 30 -X PUT \
            "https://api.cloudflare.com/client/v4/accounts/${ACCOUNT_ID}/workers/scripts/cli-blackroadio" \
            -H "Authorization: Bearer ${CF_TOKEN}" \
            -H "Content-Type: application/javascript" \
            --data-binary @workers/blackroad-subdomains/cli-blackroadio.js)
          echo "$RESP" | python3 -c "import json,sys; d=json.load(sys.stdin); print('Deploy cli: SUCCESS' if d.get('success') else 'Deploy cli: FAILED - '+str(d.get('errors')))"

      - name: Deploy learn-blackroadio
        run: |
          RESP=$(curl -s --max-time 30 -X PUT \
            "https://api.cloudflare.com/client/v4/accounts/${ACCOUNT_ID}/workers/scripts/learn-blackroadio" \
            -H "Authorization: Bearer ${CF_TOKEN}" \
            -H "Content-Type: application/javascript" \
            --data-binary @workers/blackroad-subdomains/learn-blackroadio.js)
          echo "$RESP" | python3 -c "import json,sys; d=json.load(sys.stdin); print('Deploy learn: SUCCESS' if d.get('success') else 'Deploy learn: FAILED - '+str(d.get('errors')))"

      - name: Deploy api-v2-blackroadio
        run: |
          RESP=$(curl -s --max-time 30 -X PUT \
            "https://api.cloudflare.com/client/v4/accounts/${ACCOUNT_ID}/workers/scripts/api-v2-blackroadio" \
            -H "Authorization: Bearer ${CF_TOKEN}" \
            -H "Content-Type: application/javascript" \
            --data-binary @workers/blackroad-subdomains/api-v2-blackroadio.js)
          echo "$RESP" | python3 -c "import json,sys; d=json.load(sys.stdin); print('Deploy api-v2: SUCCESS' if d.get('success') else 'Deploy api-v2: FAILED - '+str(d.get('errors')))"

      - name: Deploy agents-blackroadio
        run: |
          RESP=$(curl -s --max-time 30 -X PUT \
            "https://api.cloudflare.com/client/v4/accounts/${ACCOUNT_ID}/workers/scripts/agents-blackroadio" \
            -H "Authorization: Bearer ${CF_TOKEN}" \
            -H "Content-Type: application/javascript" \
            --data-binary @workers/blackroad-subdomains/agents-blackroadio.js)
          echo "$RESP" | python3 -c "import json,sys; d=json.load(sys.stdin); print('Deploy agents: SUCCESS' if d.get('success') else 'Deploy agents: FAILED - '+str(d.get('errors')))"

      - name: Configure DNS and Routes
        run: |
          echo "=== Fetching existing routes ==="
          ALL_ROUTES=$(curl -s --max-time 30 \
            "https://api.cloudflare.com/client/v4/zones/${ZONE_ID}/workers/routes" \
            -H "Authorization: Bearer ${CF_TOKEN}")

          declare -A NAMES=([0]="gateway-blackroadio" [1]="cli-blackroadio" [2]="learn-blackroadio" [3]="api-v2-blackroadio" [4]="agents-blackroadio")
          declare -A SUBS=([0]="gateway" [1]="cli" [2]="learn" [3]="api-v2" [4]="agents")

          for i in 0 1 2 3 4; do
            W="${NAMES[$i]}"
            SUB="${SUBS[$i]}"
            echo ""
            echo "--- $W ($SUB.blackroad.io) ---"

            # DNS check/create
            DNS_RESP=$(curl -s --max-time 30 \
              "https://api.cloudflare.com/client/v4/zones/${ZONE_ID}/dns_records?name=${SUB}.blackroad.io&type=AAAA" \
              -H "Authorization: Bearer ${CF_TOKEN}")
            COUNT=$(python3 -c "import json,sys; d=json.loads(sys.argv[1]); print(len(d.get('result',[])))" "$DNS_RESP" 2>/dev/null || echo 0)
            if [[ "$COUNT" -gt 0 ]]; then
              echo "  DNS: existing ($COUNT)"
            else
              CR=$(curl -s --max-time 30 -X POST \
                "https://api.cloudflare.com/client/v4/zones/${ZONE_ID}/dns_records" \
                -H "Authorization: Bearer ${CF_TOKEN}" \
                -H "Content-Type: application/json" \
                -d "{\"type\":\"AAAA\",\"name\":\"${SUB}.blackroad.io\",\"content\":\"100::\",\"proxied\":true,\"ttl\":1}")
              python3 -c "import json,sys; d=json.loads(sys.argv[1]); print('  DNS: created' if d.get('success') else '  DNS: FAILED - '+str(d.get('errors')))" "$CR"
            fi

            # Route check/create
            REXISTS=$(python3 -c "
          import json, sys
          routes = json.loads(sys.argv[1]).get('result', [])
          found = any('${SUB}.blackroad.io' in r.get('pattern','') for r in routes)
          print('true' if found else 'false')
          " "$ALL_ROUTES" 2>/dev/null || echo false)
            if [[ "$REXISTS" == "true" ]]; then
              echo "  Route: existing"
            else
              RR=$(curl -s --max-time 30 -X POST \
                "https://api.cloudflare.com/client/v4/zones/${ZONE_ID}/workers/routes" \
                -H "Authorization: Bearer ${CF_TOKEN}" \
                -H "Content-Type: application/json" \
                -d "{\"pattern\":\"${SUB}.blackroad.io/*\",\"script\":\"${W}\"}")
              python3 -c "import json,sys; d=json.loads(sys.argv[1]); print('  Route: created' if d.get('success') else '  Route: FAILED - '+str(d.get('errors')))" "$RR"
            fi
          done

      - name: Health Checks
        run: |
          echo "Waiting 15s for propagation..."
          sleep 15
          for SUB in gateway cli learn api-v2 agents; do
            CODE=$(curl -s --max-time 15 -o /dev/null -w "%{http_code}" "https://${SUB}.blackroad.io/health" || echo "ERR")
            BODY=$(curl -s --max-time 15 "https://${SUB}.blackroad.io/health" || echo "{}")
            echo "${SUB}.blackroad.io/health â†’ HTTP ${CODE} | ${BODY}"
          done
