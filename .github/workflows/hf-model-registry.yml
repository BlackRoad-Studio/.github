name: "ðŸ¤— HuggingFace Model Registry Sync"
on:
  schedule:
    - cron: '0 4 * * *'   # Daily 4am UTC
  workflow_dispatch:
    inputs:
      model:
        description: 'Pull specific model (e.g., Qwen/Qwen2.5-7B-Instruct)'
        required: false
        default: 'none'

jobs:
  sync-registry:
    runs-on: [self-hosted, cecilia]
    steps:
      - uses: actions/checkout@v4

      - name: Install/Update HF Hub
        run: pip3 install -q --upgrade huggingface_hub 2>/dev/null || true

      - name: List models on cecilia
        run: |
          echo "=== Ollama models on cecilia ==="
          ollama list 2>/dev/null || curl -sf http://localhost:11434/api/tags 2>/dev/null | python3 -m json.tool || echo "ollama not running"

      - name: Pull model if specified
        if: github.event.inputs.model != ''
        env:
          HF_TOKEN: ${{ secrets.HUGGINGFACE_TOKEN }}
        run: |
          MODEL="${{ github.event.inputs.model }}"
          echo "ðŸ¤— Pulling: $MODEL"
          # Convert HF model ID to ollama format
          MODEL_SHORT=$(echo "$MODEL" | tr '/' '-' | tr '[:upper:]' '[:lower:]')
          # Try ollama pull first (if model is in ollama registry)
          curl -X POST http://localhost:11434/api/pull \
            -H 'Content-Type: application/json' \
            -d '{"name":"'"$MODEL_SHORT"'"}' \
            --no-buffer 2>/dev/null | tail -2 || true
          echo "âœ… Model pull requested"

      - name: Update model registry
        run: |
          curl -sf http://localhost:11434/api/tags 2>/dev/null > agents/platform-registry/ollama-models.json || true
          if [ -s agents/platform-registry/ollama-models.json ]; then
            git config user.email "actions@blackroad.io"
            git config user.name "BlackRoad Actions"
            git add agents/platform-registry/ollama-models.json
            git diff --staged --quiet || git commit -m "chore: update ollama model registry [skip ci]

Co-authored-by: Copilot <223556219+Copilot@users.noreply.github.com>"
            git push origin HEAD || true
          fi
          echo "âœ… Registry updated"
