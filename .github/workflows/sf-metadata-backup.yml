name: Salesforce Metadata Backup
on:
  schedule:
    - cron: '0 1 * * *'   # daily 1am UTC
  push:
    branches: [master, main]
    paths:
      - 'blackroad-sf/**'
  workflow_dispatch:
    inputs:
      org_alias:
        description: Salesforce org alias
        default: blackroad-prod

jobs:
  backup-metadata:
    runs-on: [self-hosted, pi, alice]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Salesforce CLI
        run: |
          which sf || which sfdx || \
            npm install -g @salesforce/cli 2>/dev/null || \
            (npm install -g sfdx-cli 2>/dev/null; ln -sf $(which sfdx) /usr/local/bin/sf 2>/dev/null) || true

      - name: Authenticate to Salesforce
        env:
          SF_AUTH_URL: ${{ secrets.SF_AUTH_URL }}
          SF_INSTANCE_URL: ${{ secrets.SALESFORCE_INSTANCE_URL }}
          SF_ACCESS_TOKEN: ${{ secrets.SALESFORCE_ACCESS_TOKEN }}
        run: |
          if [ -n "$SF_AUTH_URL" ]; then
            echo "$SF_AUTH_URL" > /tmp/sf-auth.txt
            sf org login sfdx-url --sfdx-url-file /tmp/sf-auth.txt --alias "${{ github.event.inputs.org_alias || 'blackroad-prod' }}" 2>/dev/null && \
              echo "‚úÖ Authenticated via auth URL" || echo "‚ö†Ô∏è SF auth failed"
            rm -f /tmp/sf-auth.txt
          else
            echo "‚ö†Ô∏è SF_AUTH_URL not set ‚Äî using existing auth"
          fi

      - name: Retrieve metadata
        run: |
          ALIAS="${{ github.event.inputs.org_alias || 'blackroad-prod' }}"
          BACKUP_DIR="backups/salesforce/$(date +%Y-%m-%d)"
          mkdir -p "$BACKUP_DIR"

          # Retrieve core metadata types
          TYPES="ApexClass,ApexTrigger,LightningComponentBundle,AuraDefinitionBundle,CustomObject,Flow,Layout,PermissionSet,Profile,CustomField"

          sf project retrieve start \
            --target-org "$ALIAS" \
            --metadata "$TYPES" \
            --output-dir "$BACKUP_DIR" 2>/dev/null && \
            echo "‚úÖ Metadata retrieved to $BACKUP_DIR" || \
            echo "‚ö†Ô∏è SF retrieve failed (org may not be authorized)"

          # Count retrieved files
          COUNT=$(find "$BACKUP_DIR" -type f 2>/dev/null | wc -l)
          echo "üìä Retrieved $COUNT metadata files"

      - name: Commit backup
        run: |
          git config user.name "blackroad-bot"
          git config user.email "blackroad.systems@gmail.com"
          git add backups/salesforce/ 2>/dev/null || true
          git diff --staged --quiet && echo "No metadata changes" || \
            git commit -m "chore: SF metadata backup $(date +%Y-%m-%d) [skip ci] [skip release] [skip-bump]" && \
            git push origin master

      - name: Sync backup to Google Drive
        run: |
          if which rclone &>/dev/null && rclone listremotes 2>/dev/null | grep -q gdrive; then
            rclone sync backups/salesforce/ gdrive:blackroad-backups/salesforce/ 2>/dev/null && \
              echo "‚úÖ Backed up to Google Drive" || echo "‚ö†Ô∏è GDrive sync failed"
          else
            echo "‚ö†Ô∏è rclone not configured ‚Äî skipping GDrive backup"
          fi
