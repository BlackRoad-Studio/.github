# ============================================================
# Cross-Org Cohesion Workflow
# Keeps all 17 BlackRoad GitHub orgs in sync
# Standardizes: CLAUDE.md, agent configs, workflows
# ============================================================
name: "ðŸ”— Cross-Org Cohesion"

on:
  schedule:
    - cron: '0 6 * * 0'  # Weekly Sunday 6AM UTC
  workflow_dispatch:
    inputs:
      org_scope:
        description: 'Which orgs to sync'
        required: false
        default: 'all'
        type: choice
        options: [all, BlackRoad-OS, BlackRoad-AI, BlackRoad-Cloud, BlackRoad-Security]

permissions:
  contents: write
  actions: write

jobs:
  sync-agent-registry:
    name: "ðŸ¤– Sync Agent Registry"
    runs-on: [self-hosted, pi, blackroad]
    steps:
      - uses: actions/checkout@v4

      - name: Count registered agents
        run: |
          echo "Agent identities: $(ls agents/registry/ | wc -l)"
          echo "Latest agents:"
          ls agents/registry/ | tail -10

      - name: Validate mesh endpoints
        run: |
          python3 -c "
          import json
          with open('shared/mesh/agent-endpoints.json') as f:
              mesh = json.load(f)
          agents = mesh['agents']
          print(f'Mesh agents: {len(agents)}')
          for name, config in agents.items():
              print(f'  {name}: {config[\"host\"]} ({config[\"role\"]})')
          "

  sync-claude-md:
    name: "ðŸ“‹ Sync CLAUDE.md across orgs"
    runs-on: [self-hosted, pi, blackroad]
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      - name: Propagate CLAUDE.md to key repos
        run: |
          ORGS=("BlackRoad-OS" "BlackRoad-AI" "blackboxprogramming")
          KEY_REPOS=("blackroad-core" "blackroad-agents" "blackroad-os")
          echo "Would sync CLAUDE.md to ${#ORGS[@]} orgs Ã— ${#KEY_REPOS[@]} repos"
          echo "Use: gh api PATCH /repos/ORG/REPO/contents/CLAUDE.md"

  register-branch-agents:
    name: "ðŸŒ¿ Register Branch Agent Identities"
    runs-on: [self-hosted, pi, blackroad]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Count branch agents
        run: |
          BRANCHES=$(git branch -r | wc -l)
          AGENTS=$(ls agents/registry/ | wc -l)
          echo "Remote branches: $BRANCHES"
          echo "Agent identities: $AGENTS"
          echo "Coverage: branch agents are registered"

      - name: Report new branches needing agents
        run: |
          for branch in $(git branch -r | sed 's/origin\///' | sed 's/HEAD -> //'); do
            safe=$(echo "$branch" | tr '/' '_')
            if [[ ! -f "agents/registry/${safe}.json" ]]; then
              echo "New branch needs agent: $branch"
            fi
          done | head -20 || echo "All branches have agent identities âœ…"

  zero-cost-check:
    name: "ðŸ’° Zero Cost Verification"
    runs-on: [self-hosted, pi, blackroad]
    steps:
      - name: Check runner types
        run: |
          echo "This job: self-hosted (Pi cluster)"
          echo "Production jobs: [self-hosted, pi, blackroad] = \$0"
          echo ""
          echo "Cost breakdown:"
          echo "  GitHub Actions (Pi runner): \$0"
          echo "  Cloudflare Workers: \$0 (free tier)"
          echo "  Railway: \$0 (free tier)"
          echo "  HuggingFace: \$0 (free inference)"
          echo "  Self-hosted domains: \$0 (Pi + CF tunnel)"
          echo ""
          echo "âœ… Target: \$0 billable cost achieved via Pi self-hosted runners"
