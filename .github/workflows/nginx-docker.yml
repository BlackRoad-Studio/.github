name: "ðŸŒ Nginx via Docker on Cecilia"
on:
  workflow_dispatch:
jobs:
  nginx:
    runs-on: [self-hosted, cecilia]
    steps:
      - uses: actions/checkout@v4
      
      - name: Fix docker permissions
        run: |
          # Add current user to docker group socket access
          ls -la /var/run/docker.sock
          # Try via sg if in docker group
          groups | tr ' ' '\n' | grep docker || echo "not in docker group"
          
      - name: Start nginx container (as docker group)
        run: |
          mkdir -p ~/nginx/conf.d ~/var/www/html
          echo '{"status":"ok","host":"cecilia","tier":1}' > ~/var/www/html/health.json
          
          # Use sudo just for docker (single command, more likely to work)
          sudo docker stop blackroad-nginx 2>/dev/null || true
          sudo docker rm blackroad-nginx 2>/dev/null || true
          sudo docker run -d \
            --name blackroad-nginx \
            --restart unless-stopped \
            -p 80:80 -p 443:443 \
            -v ~/nginx/conf.d:/etc/nginx/conf.d:ro \
            -v ~/var/www/html:/usr/share/nginx/html:ro \
            nginx:alpine
          sleep 3
          sudo docker ps --filter name=blackroad-nginx --format "{{.Names}} {{.Status}}"
          curl -sf http://localhost/ && echo "âœ… nginx serving"
