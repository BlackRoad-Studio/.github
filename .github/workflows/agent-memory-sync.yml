name: Agent Memory Sync
on:
  schedule:
    - cron: '0 */6 * * *'   # every 6 hours
  push:
    branches: [master, main]
    paths:
      - 'memory/**'
      - 'agents/identities/**'
  workflow_dispatch:

jobs:
  sync-memory:
    runs-on: [self-hosted, pi]
    steps:
      - uses: actions/checkout@v4

      - name: Sync memory journals to Pi fleet
        run: |
          echo "=== Syncing memory to Pi fleet ==="
          PIES=(cecilia octavia aria alice)
          for pi in "${PIES[@]}"; do
            echo "→ Syncing to $pi..."
            # Sync memory directory
            rsync -az --timeout=10 \
              memory/ "$pi":~/blackroad/memory/ 2>/dev/null && \
              echo "  ✅ memory synced" || echo "  ⚠️ sync failed"
            # Sync agent identities
            rsync -az --timeout=10 \
              agents/identities/ "$pi":~/blackroad/agents/identities/ 2>/dev/null && \
              echo "  ✅ identities synced" || echo "  ⚠️ identities sync failed"
          done

      - name: Pull memory updates from fleet
        run: |
          echo "=== Collecting memory updates ==="
          for pi in cecilia octavia aria alice; do
            # Pull any new journal entries from Pi
            ssh -o ConnectTimeout=5 -o BatchMode=yes "$pi" \
              "cat ~/blackroad/memory/journals/master-journal.jsonl 2>/dev/null | tail -20" 2>/dev/null | \
              while read -r line; do
                HASH=$(echo "$line" | python3 -c "import sys,json,hashlib; d=json.loads(sys.stdin.read()); print(d.get('hash','')[:12])" 2>/dev/null)
                # Only append if not already in local journal
                if [ -n "$HASH" ] && ! grep -q "$HASH" memory/journals/master-journal.jsonl 2>/dev/null; then
                  echo "$line" >> memory/journals/master-journal.jsonl
                fi
              done || true
          done
          echo "✅ Memory sync complete"

      - name: Update session state
        run: |
          python3 - <<'EOF'
          import json, os, hashlib, datetime

          state_file = "memory/sessions/current-session.json"
          try:
              with open(state_file) as f:
                  state = json.load(f)
          except:
              state = {}

          state["last_memory_sync"] = datetime.datetime.utcnow().isoformat() + "Z"
          state["sync_count"] = state.get("sync_count", 0) + 1

          with open(state_file, "w") as f:
              json.dump(state, f, indent=2)
          print(f"✅ Session state updated (sync #{state['sync_count']})")
          EOF

      - name: Commit memory updates
        run: |
          git config user.name "blackroad-bot"
          git config user.email "blackroad.systems@gmail.com"
          git add memory/ agents/identities/
          git diff --staged --quiet && echo "No changes to commit" || \
            git commit -m "chore: agent memory sync [skip ci] [skip release] [skip-bump]" && \
            git push origin master
