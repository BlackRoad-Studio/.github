name: "☁️ Cloudflare Deploy from Pi"
on:
  push:
    branches: [master]
    paths: ['workers/**', 'blackroad-web/**', '.github/workflows/cloudflare-pi-deploy.yml']
  workflow_dispatch:
    inputs:
      target:
        description: 'Deploy target'
        required: false
        default: 'workers'
        type: choice
        options: [workers, pages, all]

jobs:
  deploy-workers:
    if: github.event.inputs.target != 'pages'
    runs-on: [self-hosted, gematria-do]
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node 20 + Wrangler
        run: |
          source ~/.nvm/nvm.sh && nvm use 20 --delete-prefix 2>/dev/null
          node --version
          wrangler --version
          
      - name: Deploy Workers
        run: |
          source ~/.nvm/nvm.sh && nvm use 20
          echo "Deploying Cloudflare Workers from gematria..."
          
          # Find all wrangler.toml files and deploy
          DEPLOYED=0
          ROOT="$GITHUB_WORKSPACE"
          for toml in $(find "$ROOT" -name "wrangler.toml" -not -path "*/node_modules/*" -not -path "*/.git/*" 2>/dev/null | head -20); do
            DIR=$(dirname "$toml")
            NAME=$(grep "^name" "$toml" | head -1 | cut -d'"' -f2)
            echo "  Deploying: $NAME from $DIR"
            cd "$DIR"
            wrangler deploy --config wrangler.toml 2>&1 | tail -2 || echo "  ⚠️ $NAME deploy skipped"
            cd "$ROOT"
            DEPLOYED=$((DEPLOYED+1))
          done
          echo "✅ Deployed $DEPLOYED workers"

  deploy-tunnel:
    runs-on: [self-hosted, cecilia]
    steps:
      - name: Verify Cloudflare Tunnel
        run: |
          # Check tunnel status
          systemctl status cloudflared --no-pager 2>&1 | head -3 || \
          ps aux | grep cloudflared | grep -v grep | head -2 || \
          echo "⚠️ cloudflared not running - check tunnel config"
          echo "✅ Tunnel check done"
