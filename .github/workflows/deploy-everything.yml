name: Deploy Everything â€” Railway + Cloudflare + Pi

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'What to deploy'
        required: false
        default: 'all'
        type: choice
        options: [all, railway, cloudflare, pi-workers]
  schedule:
    - cron: '0 6 * * 1'  # Every Monday 6am UTC

jobs:
  railway-redeploy:
    name: ðŸš‚ Railway â€” Redeploy All Services
    runs-on: [self-hosted, blackroad-fleet]
    if: ${{ github.event.inputs.target == 'railway' || github.event.inputs.target == 'all' || github.event_name == 'schedule' }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure Railway CLI
        run: |
          mkdir -p ~/bin ~/npm-global
          if [ ! -f ~/bin/railway ]; then
            curl -sSL https://github.com/railwayapp/cli/releases/download/v4.30.4/railway-v4.30.4-aarch64-unknown-linux-musl.tar.gz \
              -o /tmp/railway.tar.gz && tar xzf /tmp/railway.tar.gz -C ~/bin/ && chmod +x ~/bin/railway
          fi
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: Redeploy Priority Railway Projects
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          export PATH="$HOME/bin:$PATH"
          
          # Core projects to keep live
          PROJECTS=(
            "9d3d2549-3778-4c86-8afd-cefceaaa74d2"   # BlackRoad Core
            "495fce45-ba8e-478d-b7be-feeeccd6f4f6"   # blackroad-os-orchestrator
            "3687d17c-d55c-4301-a68f-2d8ddd3ebdfe"   # blackroad-agents
            "55c39406-5f33-46ef-b30e-0fb1826869b9"   # blackroad-agents-primary
            "bcdb6a9d-cdef-430e-bfac-91fa9860719b"   # blackroad-api-production
            "a97a64ba-abf9-4820-93f5-e5e3dcea8134"   # blackroad-web
          )
          
          for PROJECT_ID in "${PROJECTS[@]}"; do
            echo "ðŸš‚ Redeploying $PROJECT_ID..."
            railway redeploy --service latest --environment production \
              --project "$PROJECT_ID" --yes 2>/dev/null \
            || echo "  âš ï¸ Skip (no active deployment)"
          done
          echo "âœ… Railway redeploy complete"

  cloudflare-workers:
    name: â˜ï¸ Cloudflare â€” Deploy Core Workers
    runs-on: [self-hosted, blackroad-fleet]
    if: ${{ github.event.inputs.target == 'cloudflare' || github.event.inputs.target == 'all' || github.event_name == 'schedule' }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Wrangler
        run: |
          mkdir -p ~/npm-global ~/bin
          npm config set prefix ~/npm-global
          npm install -g wrangler 2>/dev/null || true
          ln -sf ~/npm-global/bin/wrangler ~/bin/wrangler 2>/dev/null || true
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && source "$NVM_DIR/nvm.sh" && nvm use 20 2>/dev/null || true
          echo "$HOME/bin:$HOME/npm-global/bin" >> $GITHUB_PATH

      - name: Deploy Core Cloudflare Workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          export PATH="$HOME/bin:$HOME/npm-global/bin:$PATH"
          
          # Deploy each worker from wrangler-configs/
          DEPLOYED=0
          FAILED=0
          
          for cfg in wrangler-configs/*/wrangler.toml wrangler-configs/*.toml; do
            [ -f "$cfg" ] || continue
            DIR=$(dirname "$cfg")
            NAME=$(basename "$DIR")
            echo -n "  â˜ï¸  $NAME ... "
            cd "$DIR"
            wrangler deploy --env production 2>/dev/null && echo "âœ…" && DEPLOYED=$((DEPLOYED+1)) \
              || echo "âš ï¸ skip" && FAILED=$((FAILED+1))
            cd - > /dev/null
          done
          
          echo "Deployed: $DEPLOYED | Skipped: $FAILED"

  pi-health:
    name: ðŸ¥§ Pi Fleet â€” Health + Service Check
    runs-on: [self-hosted, blackroad-fleet]
    steps:
      - name: Check Pi services
        run: |
          echo "=== Pi Fleet Health ==="
          echo "Runner: $(hostname)"
          echo "Disk: $(df -h / | tail -1)"
          echo "RAM: $(free -h | grep Mem)"
          echo ""
          echo "Services:"
          curl -sf http://localhost:3000/health && echo "  âœ… web server" || echo "  âŒ web server down"
          curl -sf http://localhost:11434/api/tags > /dev/null 2>&1 && echo "  âœ… ollama" || echo "  âšª ollama not running"
          pgrep -f cloudflared > /dev/null && echo "  âœ… cloudflared" || echo "  âŒ cloudflared down"
          
          # Auto-restart web server if down
          if ! curl -sf http://localhost:3000/health > /dev/null 2>&1; then
            echo "  ðŸ”„ Restarting web server..."
            nohup python3 ~/blackroad-server.py > /tmp/brs.log 2>&1 &
          fi
