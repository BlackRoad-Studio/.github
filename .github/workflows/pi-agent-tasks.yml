name: Pi Agent Task Dispatcher
on:
  workflow_dispatch:
    inputs:
      task:
        description: 'Task to dispatch to Pi agents'
        required: true
        type: choice
        options:
          - health-check
          - deploy-nginx
          - sync-gdrive
          - update-ollama
          - build-registry
          - salesforce-deploy
          - cloudflare-deploy
          - railway-deploy
          - hf-push
          - full-sync
      node:
        description: 'Target node (all/octavia/alice/aria/gematria/shellfish)'
        default: 'all'
        required: false
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours health check

jobs:
  dispatch:
    runs-on: [self-hosted, pi]
    timeout-minutes: 30
    env:
      TASK: ${{ github.event.inputs.task || 'health-check' }}
      NODE: ${{ github.event.inputs.node || 'all' }}
    steps:
      - uses: actions/checkout@v4

      - name: Health Check All Nodes
        if: env.TASK == 'health-check' || env.TASK == 'full-sync'
        run: |
          echo "ğŸ¥ Checking Pi fleet health..."
          NODES="192.168.4.38 192.168.4.49 192.168.4.82 159.65.43.12"
          for IP in $NODES; do
            if ping -c1 -W2 $IP &>/dev/null; then
              echo "âœ… $IP is online"
            else
              echo "âš ï¸  $IP unreachable"
            fi
          done

      - name: Sync Local Repo to All Pis
        if: env.TASK == 'full-sync'
        run: |
          echo "ğŸ”„ Syncing repo to Pi fleet..."
          for HOST in octavia alice aria; do
            echo "â†’ Syncing to $HOST..."
            rsync -az --delete \
              --exclude='.git' --exclude='node_modules' --exclude='*.db' \
              ./ ${HOST}:~/blackroad/ 2>&1 | tail -2 || echo "âš ï¸  $HOST sync failed"
          done

      - name: Deploy Nginx Config
        if: env.TASK == 'deploy-nginx'
        run: |
          echo "ğŸŒ Deploying nginx to octavia..."
          scp infra/nginx/nginx.conf octavia:/tmp/blackroad-nginx.conf
          # Nginx needs sudo â€” uses sudoers NOPASSWD if configured
          ssh octavia "sudo cp /tmp/blackroad-nginx.conf /etc/nginx/nginx.conf && sudo nginx -t && sudo systemctl reload nginx && echo 'âœ… nginx deployed'" || echo "âš ï¸  Need to run manually with sudo"

      - name: Update Ollama Models
        if: env.TASK == 'update-ollama'
        run: |
          echo "ğŸ¤– Updating Ollama on octavia..."
          ssh octavia "ollama pull qwen2.5:3b && ollama pull nomic-embed-text && echo 'âœ… Models updated'"

      - name: Deploy to Cloudflare
        if: env.TASK == 'cloudflare-deploy' || env.TASK == 'full-sync'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_OAUTH_TOKEN: ${{ secrets.WRANGLER_OAUTH_TOKEN }}
        run: |
          if [ -z "$CLOUDFLARE_API_TOKEN" ]; then
            echo "âš ï¸  CLOUDFLARE_API_TOKEN not set â€” skipping"
            exit 0
          fi
          echo "â˜ï¸  Deploying to Cloudflare..."
          npm install -g wrangler 2>/dev/null || true
          # Deploy any workers found
          find . -name 'wrangler.toml' -maxdepth 3 | head -5 | while read wf; do
            dir=$(dirname $wf)
            echo "â†’ Deploying $dir..."
            cd $dir && wrangler deploy --minify 2>&1 | tail -2 || true
            cd - > /dev/null
          done

      - name: Deploy to Railway
        if: env.TASK == 'railway-deploy'
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "âš ï¸  RAILWAY_TOKEN not set â€” skipping"
            exit 0
          fi
          echo "ğŸš‚ Deploying to Railway..."
          npm install -g @railway/cli 2>/dev/null || true
          railway up --service blackroad-core 2>&1 | tail -5 || true

      - name: Salesforce Deploy
        if: env.TASK == 'salesforce-deploy'
        env:
          SFDX_AUTH_URL: ${{ secrets.SFDX_AUTH_URL }}
        run: |
          if [ -z "$SFDX_AUTH_URL" ]; then
            echo "âš ï¸  SFDX_AUTH_URL not set â€” skipping"
            exit 0
          fi
          echo "âš¡ Deploying to Salesforce..."
          cd blackroad-sf || exit 0
          npm install 2>/dev/null || true
          npx sf project deploy start --target-org production 2>&1 | tail -10 || true

      - name: Push to HuggingFace
        if: env.TASK == 'hf-push'
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          if [ -z "$HF_TOKEN" ]; then
            echo "âš ï¸  HF_TOKEN not set â€” skipping"
            exit 0
          fi
          echo "ğŸ¤— Pushing to HuggingFace..."
          pip install huggingface_hub -q 2>/dev/null || true
          python3 -c "
          from huggingface_hub import HfApi
          api = HfApi(token='$HF_TOKEN')
          print('âœ… HF authenticated as:', api.whoami()['name'])
          " || true

      - name: Build Agent Registry
        if: env.TASK == 'build-registry'
        run: |
          echo "ğŸ—‚ï¸ Building branchâ†’agent registry..."
          bash tools/agent-identity/br-agent-identity.sh init 2>&1 | tail -5
          echo "âœ… Registry updated"

      - name: Sync to Google Drive
        if: env.TASK == 'sync-gdrive' || env.TASK == 'full-sync'
        run: |
          if ! command -v rclone &>/dev/null; then
            echo "âš ï¸  rclone not installed â€” skipping gdrive sync"
            exit 0
          fi
          echo "ğŸ“¦ Syncing to Google Drive..."
          rclone sync ~/blackroad gdrive:blackroad --exclude='.git/**' --exclude='node_modules/**' 2>&1 | tail -5 || echo "âš ï¸  GDrive sync failed â€” check rclone config"

      - name: Summary
        if: always()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ğŸ Pi Agent Task Complete"
          echo "  Task: $TASK"
          echo "  Node: $NODE"
          echo "  Time: $(date)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
