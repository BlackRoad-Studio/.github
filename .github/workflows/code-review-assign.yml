name: Smart Code Review Assignment
on:
  pull_request:
    types: [opened, ready_for_review]

jobs:
  assign-reviewers:
    runs-on: [self-hosted, pi]
    if: github.event.pull_request.draft == false
    steps:
      - uses: actions/checkout@v4

      - name: Assign reviewers by changed files
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner, repo: context.repo.repo,
              pull_number: context.payload.pull_request.number, per_page: 100
            });
            const changed = files.data.map(f => f.filename);
            const pr = context.payload.pull_request;
            const author = pr.user.login;

            // Owner always reviews
            const reviewers = new Set(['blackboxprogramming']);
            reviewers.delete(author); // Can't review own PR

            // Add agent comments based on file areas
            const agentComments = [];

            if (changed.some(f => /^\.github\/workflows\//.test(f))) {
              agentComments.push('ðŸ¤– **OCTAVIA (DevOps)**: Reviewing workflow changes. Checking for $0 billing compliance and self-hosted runner configuration.');
            }
            if (changed.some(f => /^blackroad-sf\//.test(f))) {
              agentComments.push('ðŸ¤– **ALICE (SF Executor)**: Reviewing Salesforce changes. Will validate metadata API compatibility and deployment safety.');
            }
            if (changed.some(f => /security|vault|cipher|auth/i.test(f))) {
              agentComments.push('ðŸ” **CIPHER (Security)**: Security-sensitive files detected. Reviewing for credential exposure, auth bypasses, and permission escalation.');
            }
            if (changed.some(f => /^agents\/|^memory\//.test(f))) {
              agentComments.push('ðŸ’œ **CECE (Memory)**: Agent identity or memory changes detected. Reviewing continuity and hash-chain integrity.');
            }
            if (changed.some(f => /^wrangler-configs\/|cloudflare/.test(f))) {
              agentComments.push('â˜ï¸ **ARIA (CF)**: Cloudflare config changes. Reviewing worker routes, KV bindings, and deployment targets.');
            }
            if (changed.some(f => /package\.json|requirements\.txt|go\.mod/.test(f))) {
              agentComments.push('ðŸ” **PRISM (Analyst)**: Dependency changes detected. Reviewing for supply chain risks and version conflicts.');
            }

            // Post agent review comment
            if (agentComments.length > 0) {
              const body = `## ðŸ¤– Agent Code Review\n\n${agentComments.join('\n\n')}\n\n---\n_Auto-assigned by BlackRoad branch agent system_`;
              await github.rest.issues.createComment({
                owner: context.repo.owner, repo: context.repo.repo,
                issue_number: pr.number, body
              });
            }

            // Request human review
            if (reviewers.size > 0) {
              await github.rest.pulls.requestReviewers({
                owner: context.repo.owner, repo: context.repo.repo,
                pull_number: pr.number,
                reviewers: [...reviewers]
              }).catch(e => console.log('Reviewer assignment:', e.message));
            }

            console.log(`âœ… Review assigned. Agents: ${agentComments.length}, Humans: ${reviewers.size}`);
