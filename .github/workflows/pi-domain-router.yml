name: "ðŸŒ Pi Domain Router Setup"
on:
  workflow_dispatch:
  push:
    branches: [master]
    paths: ['infra/caddy/**', 'infra/nginx/**', 'scripts/install-caddy-pi.sh']

jobs:
  deploy-octavia:
    runs-on: [self-hosted, octavia]
    steps:
      - uses: actions/checkout@v4

      - name: Install Caddy if not present
        run: |
          if ! command -v caddy &>/dev/null && ! ~/.local/bin/caddy version &>/dev/null 2>&1; then
            bash scripts/install-caddy-pi.sh
          else
            CADDY_BIN=$(command -v caddy || echo ~/.local/bin/caddy)
            echo "Caddy already installed: $($CADDY_BIN version)"
          fi

      - name: Deploy Caddyfile and start router
        run: |
          CADDY_BIN=$(command -v caddy || echo ~/.local/bin/caddy)
          mkdir -p ~/.caddy
          cp infra/caddy/Caddyfile.octavia ~/.caddy/Caddyfile
          if pgrep -f "caddy run" > /dev/null; then
            $CADDY_BIN reload --config ~/.caddy/Caddyfile 2>/dev/null && echo "Caddy reloaded" || true
          else
            nohup $CADDY_BIN run --config ~/.caddy/Caddyfile > ~/.caddy/caddy.log 2>&1 &
            sleep 3
            curl -sf http://localhost:8089/health && echo "Caddy health ok" || echo "Caddy not yet ready"
          fi

  deploy-aria:
    runs-on: [self-hosted, aria]
    steps:
      - uses: actions/checkout@v4

      - name: Install Caddy if not present
        run: |
          if ! command -v caddy &>/dev/null && ! ~/.local/bin/caddy version &>/dev/null 2>&1; then
            bash scripts/install-caddy-pi.sh
          fi

      - name: Deploy Caddyfile to aria
        run: |
          CADDY_BIN=$(command -v caddy || echo ~/.local/bin/caddy)
          mkdir -p ~/.caddy
          cp infra/caddy/Caddyfile.aria ~/.caddy/Caddyfile
          if pgrep -f "caddy run" > /dev/null; then
            $CADDY_BIN reload --config ~/.caddy/Caddyfile 2>/dev/null && echo "Caddy reloaded" || true
          else
            nohup $CADDY_BIN run --config ~/.caddy/Caddyfile > ~/.caddy/caddy.log 2>&1 &
            sleep 3
            curl -sf http://localhost:8089/health && echo "Aria health ok" || echo "Caddy not yet ready"
          fi
