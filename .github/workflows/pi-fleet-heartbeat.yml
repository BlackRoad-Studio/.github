name: Pi Fleet Heartbeat
on:
  schedule:
    - cron: '*/15 * * * *'   # every 15 minutes
  workflow_dispatch:

jobs:
  heartbeat:
    runs-on: [self-hosted, pi]
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Fleet status report
        id: fleet
        run: |
          echo "=== Pi Fleet Heartbeat $(date -u) ==="
          NODES=(
            "192.168.4.89:cecilia"
            "192.168.4.38:octavia"
            "192.168.4.82:aria"
            "192.168.4.49:alice"
            "192.168.4.81:lucidia"
            "174.138.44.45:anastasia"
          )
          ONLINE=0; OFFLINE=0; OFFLINE_LIST=()
          for node in "${NODES[@]}"; do
            IP="${node%%:*}"
            NAME="${node##*:}"
            if ping -c1 -W2 "$IP" &>/dev/null; then
              LOAD=$(ssh -o ConnectTimeout=3 -o BatchMode=yes "$IP" "cat /proc/loadavg 2>/dev/null | awk '{print \$1}'" 2>/dev/null || echo "?")
              MEM=$(ssh -o ConnectTimeout=3 -o BatchMode=yes "$IP" "free -m 2>/dev/null | awk 'NR==2{printf \"%d%%\", \$3/\$2*100}'" 2>/dev/null || echo "?")
              echo "âœ… $NAME ($IP) â€” load: $LOAD  mem: $MEM"
              ONLINE=$((ONLINE+1))
            else
              echo "âŒ $NAME ($IP) â€” OFFLINE"
              OFFLINE=$((OFFLINE+1))
              OFFLINE_LIST+=("$NAME")
            fi
          done
          echo "---"
          echo "Online: $ONLINE/6  Offline: $OFFLINE/6"
          echo "online=$ONLINE" >> $GITHUB_OUTPUT
          echo "offline=$OFFLINE" >> $GITHUB_OUTPUT
          echo "offline_list=${OFFLINE_LIST[*]}" >> $GITHUB_OUTPUT

      - name: Runner status
        run: |
          echo "=== Runner Processes ==="
          ps aux 2>/dev/null | grep -i "actions-runner\|Runner.Listener" | grep -v grep | \
            awk '{print "  PID:"$2, "CPU:"$3"%", $11}' || echo "No runners active on this node"

      - name: Disk usage check
        run: |
          echo "=== Disk Usage ==="
          df -h / 2>/dev/null | awk 'NR==2{print "  Root: "$5" used ("$3"/"$2")"}'
          USAGE=$(df / | awk 'NR==2{print $5}' | tr -d '%')
          if [ "$USAGE" -gt 90 ]; then
            echo "âš ï¸ DISK CRITICAL: ${USAGE}% used!"
            echo "disk_critical=true" >> $GITHUB_OUTPUT
          fi

      - name: Alert on critical issues
        if: steps.fleet.outputs.offline > 2
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const offline = '${{ steps.fleet.outputs.offline_list }}';
            const count = '${{ steps.fleet.outputs.offline }}';
            // Only create issue if one doesn't exist already
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner, repo: context.repo.repo,
              labels: 'fleet-alert', state: 'open'
            });
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner, repo: context.repo.repo,
                title: `ðŸš¨ Pi Fleet Alert: ${count} nodes offline`,
                body: `**Offline nodes:** ${offline}\n\n**Time:** ${new Date().toISOString()}\n\nCheck physical hardware and network connectivity.`,
                labels: ['fleet-alert', 'incident']
              });
            }
